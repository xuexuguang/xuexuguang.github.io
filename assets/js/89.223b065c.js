(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{590:function(s,a,t){"use strict";t.r(a);var n=t(15),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"worker抢占机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#worker抢占机制"}},[s._v("#")]),s._v(" worker抢占机制")]),s._v(" "),t("p",[s._v("master：一次性fork多个worker进程")]),s._v(" "),t("p",[s._v("worker：基于互斥锁进行抢占client的请求，然后开始进行处理\n"),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201202220701359.png",alt:"image-20201202220701359"}})]),s._v(" "),t("h2",{attrs:{id:"传统服务器事件处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#传统服务器事件处理"}},[s._v("#")]),s._v(" 传统服务器事件处理")]),s._v(" "),t("p",[s._v("客户端阻塞时，master进程通过fork进程来处理进程，大量的连接进来会耗尽服务器资源")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201203101228122.png",alt:"image-20201203101228122"}}),s._v(" "),t("h2",{attrs:{id:"nginx事件处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx事件处理"}},[s._v("#")]),s._v(" Nginx事件处理")]),s._v(" "),t("p",[s._v("Nginx通过使用epoll模型，使用异步非阻塞的形式监听客户端连接，当阻塞的时候，会自动切换到另一个客户端连接上。")]),s._v(" "),t("p",[s._v("一个worker进程处理的最大连接数受限于nginx的worker_connections配置")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201202211428938.png",alt:"image-20201202211428938"}}),s._v(" "),t("h2",{attrs:{id:"同步阻塞与异步阻塞"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#同步阻塞与异步阻塞"}},[s._v("#")]),s._v(" 同步阻塞与异步阻塞")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("方式")]),s._v(" "),t("th",[s._v("说明")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("同步阻塞")]),s._v(" "),t("td",[s._v("客户端阻塞等待服务器处理完成")])]),s._v(" "),t("tr",[t("td",[s._v("同步非阻塞")]),s._v(" "),t("td",[s._v("客户端阻塞等待服务器处理，服务器可以异步处理其他任务")])]),s._v(" "),t("tr",[t("td",[s._v("异步阻塞")]),s._v(" "),t("td",[s._v("客户端异步发送请求到服务器，服务器处理完回调客户端")])]),s._v(" "),t("tr",[t("td",[s._v("异步非阻塞")]),s._v(" "),t("td",[s._v("客户端与服务端都是异步处理任务，处理完成回调给客户端")])])])]),s._v(" "),t("p",[s._v("同步与异步的区别在于"),t("font",{attrs:{color:"red"}},[s._v("客户端是否阻塞等待")]),s._v("，阻塞与非阻塞的区别在于"),t("font",{attrs:{color:"red"}},[s._v("服务器是否阻塞等待")])],1),s._v(" "),t("h2",{attrs:{id:"nginx常用命令及指令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx常用命令及指令"}},[s._v("#")]),s._v(" Nginx常用命令及指令")]),s._v(" "),t("p",[s._v("常用命令")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("命令")]),s._v(" "),t("th",[s._v("说明")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("nginx -s stop")]),s._v(" "),t("td",[s._v("强制停止nginx")])]),s._v(" "),t("tr",[t("td",[s._v("nginx -s quit")]),s._v(" "),t("td",[s._v("等待nginx处理完请求再退出")])]),s._v(" "),t("tr",[t("td",[s._v("nginx -c nginx.conf")]),s._v(" "),t("td",[s._v("指定nginx配置文件，可以解决invalid nginx pid的问题")])])])]),s._v(" "),t("p",[s._v("指令")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("指令")]),s._v(" "),t("th",[s._v("说明")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("root")]),s._v(" "),t("td",[s._v("location中会追加到root后面")])]),s._v(" "),t("tr",[t("td",[s._v("alias")]),s._v(" "),t("td",[s._v("location中会以alias的路径为主")])])])]),s._v(" "),t("h2",{attrs:{id:"日志切割"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日志切割"}},[s._v("#")]),s._v(" 日志切割")]),s._v(" "),t("p",[s._v("该方式会将现有的access.log和error.log的内容copy到新的文件中，新的请求进来内容依然会写到access.log")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token shebang important"}},[s._v("#!/bin/bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定日志目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("LOG_PATH")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/log/nginx/"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定切割的日志格式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("RECORD_TIME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("date")]),s._v(" -d "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"yesterday"')]),s._v("+%Y-%m-%d"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PID")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/run/nginx/nginx.pid\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将默认的access_log和error_log重命名为拆分后的格式")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LOG-PATH}")]),s._v("/access.log "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LOG-PATH}")]),s._v("/access."),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${RECORD_TIME).log\nmv ${LOG-PATH}")]),s._v("/error.log "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${LOG-PATH}")]),s._v("/error."),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${RECORD_TIME}")]),s._v(".Log\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 向Nginx主进程发送信号,用于重新打开日志文件")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kill")]),s._v(" -USR1 "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" $PID"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 记得修改权限 chmod +x cut_log.sh ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("也可以通过定时任务去实现自动切割，这种方式相对比较老，更新的日志分割可以结合"),t("a",{attrs:{href:"https://jingsam.github.io/2019/01/15/nginx-access-log.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("nginx变量实现区分"),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"nginx实现跨域请求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx实现跨域请求"}},[s._v("#")]),s._v(" Nginx实现跨域请求")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许跨域请求的域, *代表所有")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Origin'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许带上cookie请求")]),s._v("\n    add header "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Credentials'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许请求的方法,比如GET/POST/PUT/DELETE")]),s._v("\n    add header "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-control-Allow-Methods'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 允许请求的header")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add_header")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Access-Control-Allow-Headers'")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("跨域是浏览器的一种同源策略的限制，解决方法本质都是通过header头部的设置，除此之外还可以发送jsonp请求来解决跨域问题")]),s._v(" "),t("h2",{attrs:{id:"nginx配置静态资源防盗链"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx配置静态资源防盗链"}},[s._v("#")]),s._v(" Nginx配置静态资源防盗链")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("listen")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server_name")]),s._v(" localhost"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过验证refer头部来校验是否合法资源请求")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("valid_referers")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("imooc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("com"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 非法引入会进入下方判断")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$invalid_referer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h2",{attrs:{id:"upstream指令参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#upstream指令参数"}},[s._v("#")]),s._v(" upstream指令参数")]),s._v(" "),t("p",[s._v("upstream主要用于配置nginx的负载均衡，下面是对常用的指令的整理")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 负载均衡配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" tomcats "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# max_conns表示该server支持的最大连接数   ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".173")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" max_conns"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# weight表示权重值，请求大概率会打到该服务器上")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".174")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" weight"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1、通过server指令的slow_start参数来让其权重从0缓慢的恢复到正常值，避免大流量直接打进来再次压垮服务")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2、商业版使用，该参数不能用在hash、randomloadbalancing中,如果只有一台服务器会失效")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 3、注意如果一个组里面只有一个server，那么max_fails，fail_timeout和slow_start参数都会被忽略。并且这个服务器永远都不会被认为是不可用的")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".175")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" slow_start"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# down用于标记服务节点不可用")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".173")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" down"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# backup表示当前服务器节点是备用机，只有在其他的服务器都宕机以后，自己才会加入到集群中，被用户访问到，参数不能使用在hash和randomloadbalancing中")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".173")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" down"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示在15秒内请求某一server失败达到2次后，则认为该server已经挂了或者宕机了，随后再过15秒，这15秒内不会有新的请求到达刚刚挂掉的节点上，而是会运作的server，15秒后会再有新请求尝试连接挂掉的server，如果还是失败，重复上一过程")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".173")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" max_fails"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" fail_timeout"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保持的活跃的链接，避免频繁的创建连接，带来的性能损耗")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("keepalive")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("h2",{attrs:{id:"keepalive"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#keepalive"}},[s._v("#")]),s._v(" keepalive")]),s._v(" "),t("p",[s._v("主要是保持与后端的连接数，避免请求nginx的时候，不断的与后端建立连接带来的性能损耗。")]),s._v(" "),t("p",[s._v("详细的可以参考"),t("a",{attrs:{href:"https://www.cnblogs.com/kabi/p/7123354.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("keepalive的说明"),t("OutboundLink")],1)]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" tomcats "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".174")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" weight"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过保持与客户端的长连接，来提高吞吐量，32为长连接的个数 ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("keepalive")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tomcats"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置长连接使用的版本号 ")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_http_version")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置cookie头的connection为空 ")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_set_header")]),s._v(" Connection "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("h2",{attrs:{id:"ip-hash"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ip-hash"}},[s._v("#")]),s._v(" Ip_hash")]),s._v(" "),t("p",[s._v("ip_hash可以保证用户访问可以请求到上游服务中的固定的服务器，前提是用户ip没有发生更改。\n使用ip_hash的注意点：不能把后台服务器直接移除，只能标记为down")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" tomcats "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ip_hash")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".174")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("808")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".174")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" down"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tomcats"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("hash算法：通过对ip进行hash计算，对节点个数进行求模，最后决定落到哪个节点")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201202211638113.png",alt:"image-20201202211638113"}}),s._v(" "),t("p",[t("strong",[s._v("计算方式")])]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("参数")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("node_counts")]),s._v(" "),t("td",[s._v("服务器的节点个数")])]),s._v(" "),t("tr",[t("td",[s._v("index")]),s._v(" "),t("td",[s._v("服务器对应的索引")])]),s._v(" "),t("tr",[t("td"),s._v(" "),t("td")])])]),s._v(" "),t("p",[s._v("主要是通过"),t("code",[s._v("hash(ip) % node_counts = index")]),s._v(" 最后计算得到index，根据index来匹配对应的服务器节点")]),s._v(" "),t("p",[s._v("算法是根据ip的前3段来进行计算的，所以，"),t("font",{attrs:{color:"red"}},[s._v("同一段落的ip会落在同一台服务器上。")])],1),s._v(" "),t("h2",{attrs:{id:"一致性hash算法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一致性hash算法"}},[s._v("#")]),s._v(" 一致性hash算法")]),s._v(" "),t("p",[s._v("hash算法存在节点个数的变更，导致命中的服务器的index发生变化，为了解决该问题，出现了一致性hash算法")]),s._v(" "),t("h3",{attrs:{id:"是什么？"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#是什么？"}},[s._v("#")]),s._v(" 是什么？")]),s._v(" "),t("p",[s._v("一致性hash算法本质上是一个从0-2的32次方的线，最终形成的圆")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201202211832557.png",alt:"image-20201202211832557"}}),s._v(" "),t("h3",{attrs:{id:"基本原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#基本原理"}},[s._v("#")]),s._v(" 基本原理")]),s._v(" "),t("ol",[t("li",[s._v("通过对服务器的节点(ip或者主机)、用户的ip进行hash后，最终确认服务器节点的位置和用户所在的位置。")]),s._v(" "),t("li",[s._v("按照顺时针的方向,选择最近的节点作为访问的节点")])]),s._v(" "),t("h3",{attrs:{id:"解决的问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决的问题"}},[s._v("#")]),s._v(" 解决的问题")]),s._v(" "),t("p",[s._v("传统的hash算法，节点个数的变更，会导致全部的用户的请求发生变化。")]),s._v(" "),t("p",[s._v("一致性hash算法通过将服务器节点和用户的ip进行hash后，用户顺时针访问就近的节点，这样增加会移除节点影响的只是少部分用户。")]),s._v(" "),t("h2",{attrs:{id:"url-hash"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#url-hash"}},[s._v("#")]),s._v(" url_hash")]),s._v(" "),t("p",[s._v("根据url来路由到服务器的节点,计算方式：")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201202211909626.png",alt:"image-20201202211909626"}}),s._v(" "),t("p",[s._v("具体的配置")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("upstream")]),s._v(" tomcats "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 根据url进行hash，计算得到index作为服务器的索引")]),s._v("\n    url hash"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由请求到后端最少连接数的服务器上")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# least_conn; ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".174")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("808")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".174")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(" down"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tomcats"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("通过"),t("font",{attrs:{color:"red"}},[s._v("hash(url) % node_counts")]),t("code",[s._v("计算得到")]),s._v("index`如果url中带有/，计算得到的hash结果是不一样的，会落到不同的服务节点上的。")],1),s._v(" "),t("h2",{attrs:{id:"nginx缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nginx缓存"}},[s._v("#")]),s._v(" Nginx缓存")]),s._v(" "),t("p",[s._v("主要是缓存后端server的请求到服务器上，来缓解服务器本身的压力")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201202212013586.png",alt:"image-20201202212013586"}}),s._v(" "),t("h3",{attrs:{id:"控制浏览器的缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#控制浏览器的缓存"}},[s._v("#")]),s._v(" 控制浏览器的缓存")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("html "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alias")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("html"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 10s后失效")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("expires")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 到达指定的时间后失效")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expires @22h30m;")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 1小时前失效")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expires -1h;")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不进行缓存")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expires epoch;")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 关闭，与epoch的区别在于off后浏览器保留默认的缓存机制")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expires off;")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 永不过期")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# expires max;")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("如果文件内容发生了变化，会重新请求浏览器，max-age表示缓存内容的有效期")]),s._v(" "),t("h3",{attrs:{id:"反向代理缓存"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#反向代理缓存"}},[s._v("#")]),s._v(" 反向代理缓存")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置缓存保存的路径")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   key_zone:设置共享空间和占用的空间大小")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   max_size:设置缓存大小   ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   inactive:设置缓存的有效期，超过此时间缓存自动清理  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   use_temp_path:关闭临时目录 ")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# nginx会把请求服务器的内容缓存到该目录下，8h后会自动清理  ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_path")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("usr"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("local"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("nginx"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("upsteam_cache keys_zone"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mycache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("m max_size"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("g inactive"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("h use_temp_path"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("server")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用缓存，和keys_zone一致")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache")]),s._v(" mycache"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 针对200、304的状态码保留8h的有效期  ")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_cache_valid")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("200")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("304")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("h"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("location")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("proxy_pass")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("http")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("tomcats"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("       \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("h2",{attrs:{id:"keepalived双机主备原理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#keepalived双机主备原理"}},[s._v("#")]),s._v(" Keepalived双机主备原理")]),s._v(" "),t("p",[s._v("keepalived具有以下特点：")]),s._v(" "),t("ul",[t("li",[s._v("解决slb单点故障")]),s._v(" "),t("li",[s._v("组件免费")]),s._v(" "),t("li",[s._v("可以实现高可用的HA机制")]),s._v(" "),t("li",[s._v("基于"),t("a",{attrs:{href:"https://www.jianshu.com/p/7410507d57c3",target:"_blank",rel:"noopener noreferrer"}},[s._v("VRRP协议"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("通过主备节点争抢ip的方式来保证负载均衡节点的高可用")]),s._v(" "),t("h3",{attrs:{id:"master"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#master"}},[s._v("#")]),s._v(" master")]),s._v(" "),t("p",[s._v("通过在192.168.1.171、192.168.1.172两台物理机上安装keepalived，来实现双机主备")]),s._v(" "),t("p",[s._v("在机器192.168.1.171上配置msater节点")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v("global_defs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由id:当前安装keepalived的节点主机标识符，保证全局唯一")]),s._v("\n    router_id keep_171\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示状态是master主机还是backup备用机")]),s._v("\n    state MASTER\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该实例绑定的网卡 ")]),s._v("\n    interface "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ens33")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保证主备节点一致即可  ")]),s._v("\n    virtual_router_id "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 权重, master权重一般高于backup,如果有多个,那就是选举,谁的权重高,谁就当选")]),s._v("\n    priority "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主备之间同步检查时间间隔，单位秒 ")]),s._v("\n    adver_int "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 认证权限密码,防止非法节点进入")]),s._v("\n    authentication "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        auth_type PASS\n        auth_pass "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟出来的ip,可以有多个vip")]),s._v("\n    virtual_ipaddress "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".161")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br")])]),t("p",[s._v("服务启动后观察ip addr,发现192.168.1.161绑定到了网卡上了")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201202212247198.png",alt:"image-20201202212247198"}}),s._v(" "),t("h3",{attrs:{id:"backup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#backup"}},[s._v("#")]),s._v(" backup")]),s._v(" "),t("p",[s._v("在192.168.1.172上配置backup节点")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v("global_defs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由id:当前安装keepalived的节点主机标识符，保证全局唯一")]),s._v("\n    router_id keep_172\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 表示状态是master主机还是backup备用机")]),s._v("\n    state BACKUP\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 该实例绑定的网卡，当master节点宕机后，备用节点会替代master，会看到ens33的网卡下绑定了虚拟ip")]),s._v("\n    interface "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ens33")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保证主备节点一致即可  ")]),s._v("\n    virtual_router_id "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 权重, 权重低于master节点")]),s._v("\n    priority "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主备之间同步检查时间间隔，单位秒 ")]),s._v("\n    adver_int "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 认证权限密码,防止非法节点进入")]),s._v("\n    authentication "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        auth_type PASS\n        auth_pass "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n       \n    virtual_ipaddress "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主备节点绑定的是同一个vip")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".161")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br")])]),t("p",[s._v("为支持syetemctl的使用，注册keepalived为系统服务")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换到keepalived的源目录下 ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /usr/local/software/keepalived-2.0.20/keepalived/etc\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将init.d目录中的keepalived文件拷贝到/etc/init.d目录中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" init.d/keepalived /etc/init.d/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将sysconfig目录中的keepalived文件拷贝到/etc/sysconfig目录中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" sysconfig/keepalived  /etc/sysconfig/\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重新加载服务的配置文件")]),s._v("\nsystemctl daemon-reload\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("启动keepalived")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动keepalived")]),s._v("\nsyetemctl start keepalived\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止keepalived")]),s._v("\nsyetemctl stop keepalived\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启keepalived")]),s._v("\nsyetemctl restart keepalived\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看进程是否存在")]),s._v("\nps-ef"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("grepkeepalived\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("使用keepalived使nginx进程常驻")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 脚本存放到keepalived的配置目录下")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/keepalived/check_nginx_alive_or_not.sh\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"进程常驻"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#进程常驻"}},[s._v("#")]),s._v(" 进程常驻")]),s._v(" "),t("p",[s._v("新增检查nginx进程脚本")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# !bin/bash")]),s._v("\nnginx_process_total "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -c nginx --no-header "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$nginx_process_total")]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":then\n    /usr/local/sbin/nginx\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 等待一小会再次检查nginx，如果没有启动成功，则停止keepalived，使其启动")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\n\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 保证nginx进程常驻，如果没有正常拉起，则杀死keepalived，保证backup节点工作")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" -c nginx --no-header "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v(" -eq "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(":then\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("killall")]),s._v(" keepalived\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("新增脚本执行权限")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x /etc/keepalived/check_nginx_alive_or_not.sh\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("配置keepalived监听nginx脚本")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v("global_defs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    router_id keep_172\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_script check_nginx_alive "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    script "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/keepalived/check_nginx_alive_or_not.sh"')]),s._v("\n    interval "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每搁两秒运行一次脚本")]),s._v("\n    weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 脚本执行失败，则权重+10")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("        \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vrrp_instance 中新增监听的脚本")]),s._v("\n    track_script "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        check_nginx_alive "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 追踪nginx脚本")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("         \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("重启keepalived脚本")]),s._v(" "),t("div",{staticClass:"language-nginx line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-nginx"}},[t("code",[s._v("systemctl restart keepalived\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);
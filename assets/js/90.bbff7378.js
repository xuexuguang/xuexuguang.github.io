(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{591:function(s,a,t){"use strict";t.r(a);var n=t(15),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"lvs与nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lvs与nginx"}},[s._v("#")]),s._v(" LVS与nginx")]),s._v(" "),t("p",[s._v("vs是基于linux内核的ipvs模块工作的，是四层协议的负载均衡，主要支持LVS-nat、LVS-tun、LVS-dr的方式进行负载。")]),s._v(" "),t("p",[s._v("LVS相对nginx而言开销更低，性能更好")]),s._v(" "),t("p",[s._v("nginx的网络拓扑，请求出入都需要经过nginx会带来性能上的损耗")]),s._v(" "),t("p",[s._v("LVS的网络拓扑：请求经过LVS，响应可以不经")]),s._v(" "),t("h2",{attrs:{id:"lvs的模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lvs的模式"}},[s._v("#")]),s._v(" LVS的模式")]),s._v(" "),t("h3",{attrs:{id:"nat"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#nat"}},[s._v("#")]),s._v(" NAT")]),s._v(" "),t("p",[s._v("特点：")]),s._v(" "),t("ul",[t("li",[s._v("请求、响应都经过LVS")]),s._v(" "),t("li",[s._v("LVS提供一个对外的公网ip，后端的服务外网不能访问")]),s._v(" "),t("li",[s._v("支持端口转发")])]),s._v(" "),t("h3",{attrs:{id:"tun"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#tun"}},[s._v("#")]),s._v(" TUN")]),s._v(" "),t("p",[s._v("特点：")]),s._v(" "),t("p",[s._v("LVS需要基于ip隧道模式与后端服务建立隧道，每个节点配有网卡，后端的服务暴露在公网")]),s._v(" "),t("ul",[t("li",[s._v("响应不经过LVS")]),s._v(" "),t("li",[s._v("LVS提供虚拟ip，公网可以访问")])]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201126141908446.png",alt:"image-20201126141908446"}}),s._v(" "),t("h3",{attrs:{id:"dr"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dr"}},[s._v("#")]),s._v(" DR")]),s._v(" "),t("p",[s._v("特点：")]),s._v(" "),t("ul",[t("li",[s._v("请求经过LVS，响应经过router")]),s._v(" "),t("li",[s._v("LVS和router对外公网可访问")])]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201126141939927.png",alt:"image-20201126141939927"}}),s._v(" "),t("h2",{attrs:{id:"搭建lvs-dr模式"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搭建lvs-dr模式"}},[s._v("#")]),s._v(" 搭建LVS-DR模式")]),s._v(" "),t("h3",{attrs:{id:"服务器ip约定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#服务器ip约定"}},[s._v("#")]),s._v(" 服务器IP约定")]),s._v(" "),t("p",[s._v("LVS与后端的server的请求示例")]),s._v(" "),t("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://gitee.com/xuexuguang/images/raw/master/img/image-20201126142017891.png",alt:"image-20201126142017891"}}),s._v(" "),t("p",[s._v("通过DIP分发请求到RIP上，最终通过VIP返回响应，注意DIP与RIP需要在同一网段内")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("角色")]),s._v(" "),t("th",{staticStyle:{"text-align":"left"}},[s._v("备注")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("DIP")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("调度者的ip，负责调度后端的real server")])]),s._v(" "),t("tr",[t("td",[s._v("VIP")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("虚拟ip，用户通过虚拟ip发起请求，这里约定虚拟ip为192.168.1.15")])]),s._v(" "),t("tr",[t("td",[s._v("RIP")]),s._v(" "),t("td",{staticStyle:{"text-align":"left"}},[s._v("后端服务各个节点的ip")])])])]),s._v(" "),t("p",[s._v("调度器和所有的Real Server都配置了VIP地址，区别在于"),t("code",[s._v("LVS的VIP配置在物理网卡接口上，而Real Server都是配置在了本地接口lo上")])]),s._v(" "),t("h3",{attrs:{id:"准备工作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[s._v("#")]),s._v(" 准备工作")]),s._v(" "),t("p",[s._v("准备工作")]),s._v(" "),t("div",{staticClass:"language-Bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止网络管理")]),s._v("\nsystemctl stop NetworkManager\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 禁用网络管理")]),s._v("\nsystemctl disable NetworkManager\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装LVS集群管理工具")]),s._v("\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ipvsadm\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 确认是否安装成功")]),s._v("\nipvsadm -Ln\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("主要是为了避免网关接口的冲突,需要关闭三台服务器上的网络管理服务")]),s._v(" "),t("p",[t("strong",[s._v("注")]),s._v("："),t("code",[s._v("阿里云不支持虚拟ip")]),s._v("，腾讯云支持，但是有数量限制，网卡都需要进行付费")]),s._v(" "),t("h3",{attrs:{id:"配置调度者lvs虚拟ip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置调度者lvs虚拟ip"}},[s._v("#")]),s._v(" 配置调度者LVS虚拟IP")]),s._v(" "),t("p",[s._v("复制现有的网卡配置进行修改")]),s._v(" "),t("div",{staticClass:"language-Bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 备份网卡配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /etc/sysconfig/network-scripts/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重命名为ens33:1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ifcfg-ens33 ifcfg-ens33:1\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" ifcfg-ens33:1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("修改网卡配置")]),s._v(" "),t("div",{staticClass:"language-Bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 网卡名称，跟文件名一致")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEVICE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ens33:1"')]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ONBOOT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BOOTPROTO")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("static\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定内网的ip,即vip")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IPADDR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NETMASK")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("重启网络")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启网络")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" network restart\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h3",{attrs:{id:"配置rs的虚拟ip"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置rs的虚拟ip"}},[s._v("#")]),s._v(" 配置RS的虚拟IP")]),s._v(" "),t("p",[s._v("后端两台服务器主要调整ifcfg-lo文件，目的是为了返回用户数据报文")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /etc/sysconfig/network-scripts/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 本地环回接口，用于构建网络子接口，返回数据报文，不能被用户访问到真实服务")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ifcfg-lo ifcfg-lo:1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("lo配置修改")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("DEVICE")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("lo:1\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("IPADDR")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#子网掩码调整为255，这个跟LVS节点不一致")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NETMASK")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".255.255\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NETWORK")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.0\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("BROADCAST")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.255")]),s._v(".255.255\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ONBOOT")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("NAME")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("loopback\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("刷新网卡配置")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 刷新lo配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ifup")]),s._v(" lo "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者使用service network restart都可以")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看lo下是否新增192.168.1.150的虚拟ip")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" addr\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("h3",{attrs:{id:"配置rs的arp"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置rs的arp"}},[s._v("#")]),s._v(" 配置RS的ARP")]),s._v(" "),t("p",[t("code",[s._v("arp")]),s._v("用于更加精准的处理用户请求,是配置网卡的行为，配置arp主要是为了"),t("code",[s._v("后端server只被调度器调度")]),s._v("，因此需要限制real server的响应级别。")]),s._v(" "),t("h4",{attrs:{id:"arp-ignore"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#arp-ignore"}},[s._v("#")]),s._v(" arp_ignore")]),s._v(" "),t("p",[s._v("arp响应级别，处理请求")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("值")]),s._v(" "),t("th",[s._v("备注")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("0")]),s._v(" "),t("td",[s._v("默认值为0,只要本机配置了ip，就能响应请求")])]),s._v(" "),t("tr",[t("td",[s._v("1")]),s._v(" "),t("td",[s._v("请求的目标地址到达对应的网络接口，才会响应请求")])]),s._v(" "),t("tr",[t("td",[s._v("2")]),s._v(" "),t("td",[s._v("请求的目标地址到达对应的网络接口,且来访IP必须在该网络接口的子网段内")])]),s._v(" "),t("tr",[t("td",[s._v("3")]),s._v(" "),t("td",[s._v("不回应该网络界面的arp请求，而只对设置的唯一和连接地址做出回应")])]),s._v(" "),t("tr",[t("td",[s._v("4-7")]),s._v(" "),t("td",[s._v("保留未使用")])]),s._v(" "),t("tr",[t("td",[s._v("8")]),s._v(" "),t("td",[s._v("不回应所有（本地地址）的arp查询")])])])]),s._v(" "),t("p",[s._v("为了保证客户端的ARP广播请求可以只被调度器所响应，因此必须限制所有Real Server的arp响应级别，所以才设置arp_ignore为1，这样对于Real Server来说，因为arp请求一定来自别的主机，所以接收的网卡只能是物理接口，而Real Server又将VIP配置到了lo接口上，因此刚好不会回应，从而保证了请求只会到达调度器；")]),s._v(" "),t("h4",{attrs:{id:"arp-announce"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#arp-announce"}},[s._v("#")]),s._v(" arp_announce")]),s._v(" "),t("p",[s._v("通告行为，主要是处理返回响应")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("值")]),s._v(" "),t("th",[s._v("备注")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("0")]),s._v(" "),t("td",[s._v("所有的网络接口都可以向外通告和接收到通道")])]),s._v(" "),t("tr",[t("td",[s._v("1")]),s._v(" "),t("td",[s._v("尽可能的避免本网卡与不匹配的目标通告")])]),s._v(" "),t("tr",[t("td",[s._v("2")]),s._v(" "),t("td",[s._v("只在本网卡内通告")])])])]),s._v(" "),t("h4",{attrs:{id:"arp配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#arp配置"}},[s._v("#")]),s._v(" ARP配置")]),s._v(" "),t("p",[s._v("打开sysctl.conf")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/sysctl.conf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("配置所有网卡、默认网卡以及虚拟网卡的arp响应级别和通告行为，分别对应：all，default，lo：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 所有的网卡")]),s._v("\nnet.ipv4.conf.all.arp_ignore"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认的网卡")]),s._v("\nnet.ipv4.conf.default.arp_ignore"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lo的网卡")]),s._v("\nnet.ipv4.conf.lo.arp_ignore"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\nnet.ipv4.conf.all.arp_announce"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nnet.ipv4.conf.default.arp_announce"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nnet.ipv4.conf.lo.arp_announce"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("刷新网卡配置")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 刷新网卡配置")]),s._v("\nsysctl -p \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("增加一个网关，用于接收数据报文，当有请求到本机后，会交给lo去处理")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在两台server上分别添加route")]),s._v("\nroute add-host:192.168.1.150 dev lo:1\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 确认路由是否添加?")]),s._v("\nroute -n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将路由添加到开启自启，避免重启失效")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"route add-host:192.168.1.150 dev lo:1"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/rc.local\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("h3",{attrs:{id:"使用ipvsadm配置集群规则"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用ipvsadm配置集群规则"}},[s._v("#")]),s._v(" 使用ipvsadm配置集群规则")]),s._v(" "),t("p",[s._v("创建LVS节点，即用户访问的集群调度者")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加一个集群")]),s._v("\nipvsadm -A -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150:80 -s rr -p "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -A 添加集群")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -t tcp协议")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip地址：设置集群的访问ip，即虚拟ip")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -s 设置负载均衡算法，rr表示轮询")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -p 设置持久化连接的时间")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("添加两台服务器到集群节点")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加集群节点")]),s._v("\nipvsadm -a -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150:80 -r "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.171:80 -g\nipvsadm -a -t "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150:80 -r "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.172:80 -g\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -a 添加真实服务器")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -t tcp协议")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -r 真实服务器ip")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -g 设置为DR模式 ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("保存到规则库，否则重启失效")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ipvsadm -S \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("检查集群")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看集群列表")]),s._v("\nipvsadm -Ln \n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看集群状态")]),s._v("\nipvsadms -Ln --stats\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看请求的节点")]),s._v("\nipvsadm -Lnc\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("其他命令")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启ipvsadm，重启后需要重新配置")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" ipvsadm restart\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看持久化连接")]),s._v("\nipvsadm -Ln --persistent-conn\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看连接请求过期时间以及请求源ip和目标")]),s._v("\nipipvsadm -Lnc\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置tcp tcpfin udp的过期时间（一般保持默认）")]),s._v("\nipvsadm --set "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看过期时间")]),s._v("\nipvsadm -Ln --timeout\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("注：如果没有发生轮询，请检查节点的持久化的时间")]),s._v(" "),t("h2",{attrs:{id:"搭建keepalived-lvs-nginx"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搭建keepalived-lvs-nginx"}},[s._v("#")]),s._v(" 搭建keepalived+LVS+Nginx")]),s._v(" "),t("p",[s._v("通过配置"),t("code",[s._v("keepalived")]),s._v("来保证LVS节点的高可用")]),s._v(" "),t("h3",{attrs:{id:"master"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#master"}},[s._v("#")]),s._v(" master")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Configuration File "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" keepalived\nglobal_defs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   router_id LVS_151\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    state MASTER            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 两个 DS，一个为 MASTER 一个为 BACKUP")]),s._v("\n    interface ens33         "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当前 IP 对应的网络接口，通过 ifconfig 查询")]),s._v("\n    virtual_router_id "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟路由 ID(0-255)，在一个 VRRP 实例中主备服务器 ID 必须一样")]),s._v("\n    priority "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优先级值设定：MASTER 要比 BACKUP 的值大")]),s._v("\n    advert_int "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通告时间间隔：单位秒，主备要一致")]),s._v("\n    authentication "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 认证机制，主从节点保持一致即可")]),s._v("\n        auth_type PASS\n        auth_pass "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# VIP，可配置多个")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# LVS 配置")]),s._v("\nvirtual_server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  delay_loop "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置健康状态检查时间，单位为秒")]),s._v("\n  lb_algo rr                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 调度算法，这里用了 rr 轮询算法")]),s._v("\n  lb_kind DR                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定LVS的模式Direct Route 模式")]),s._v("\n  persistence_timeout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 持久连接超时时间，保持客户端前后请求的间隔，时间段内会落到同一台server上")]),s._v("\n  protocol TCP       \t\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 协议为tcp")]),s._v("\n  \n\treal_server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.171 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 轮询的权重")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 健康检查")]),s._v("\n      TCP_CHECK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          connect_timeout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("　　　"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接超时时间，单位为秒")]),s._v("\n          retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　　　　　　      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重试次数，旧版本为 nb_get_retry")]),s._v("\n          delay_before_retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 间隔时间　")]),s._v("\n          connect_port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\t\t\t\t "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查的端口\t")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n\treal_server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.171 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 轮询的权重")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 健康检查")]),s._v("\n      TCP_CHECK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          connect_timeout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("　　　"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接超时时间，单位为秒")]),s._v("\n          retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　　　　　　      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重试次数，旧版本为 nb_get_retry")]),s._v("\n          delay_before_retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 间隔时间　")]),s._v("\n          connect_port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\t\t\t\t "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查的端口\t")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br")])]),t("h3",{attrs:{id:"backup"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#backup"}},[s._v("#")]),s._v(" backup")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" Configuration File "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" keepalived\nglobal_defs "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   router_id LVS_152      \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\nvrrp_instance VI_1 "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    state BACKUP            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从节点指定为BACKUP")]),s._v("\n    interface ens33        \n    virtual_router_id "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 跟master节点保持一致")]),s._v("\n    priority "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("             "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 优先级比master节点低")]),s._v("\n    advert_int "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通告时间间隔：单位秒，主备要一致")]),s._v("\n    authentication "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 认证机制，主从节点保持一致即可")]),s._v("\n        auth_type PASS\n        auth_pass "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    virtual_ipaddress "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# VIP，可配置多个")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# LVS 配置，跟master的保持一致")]),s._v("\nvirtual_server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.150 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  delay_loop "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("                    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置健康状态检查时间，单位为秒")]),s._v("\n  lb_algo rr                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 调度算法，这里用了 rr 轮询算法")]),s._v("\n  lb_kind DR                      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定LVS的模式Direct Route 模式")]),s._v("\n  persistence_timeout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("          "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 持久连接超时时间，保持客户端前后请求的间隔，时间段内会落到同一台server上")]),s._v("\n  protocol TCP       \t\t\t\t\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 协议为tcp")]),s._v("\n  \n\treal_server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.171 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 轮询的权重")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 健康检查")]),s._v("\n      TCP_CHECK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          connect_timeout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("　　　"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接超时时间，单位为秒")]),s._v("\n          retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　　　　　　      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重试次数，旧版本为 nb_get_retry")]),s._v("\n          delay_before_retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 间隔时间　")]),s._v("\n          connect_port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\t\t\t\t "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查的端口\t")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n\treal_server "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".1.171 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      weight "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 轮询的权重")]),s._v("\n       "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 健康检查")]),s._v("\n      TCP_CHECK "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          connect_timeout "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("　　　"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 连接超时时间，单位为秒")]),s._v("\n          retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　　　　　　      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重试次数，旧版本为 nb_get_retry")]),s._v("\n          delay_before_retry "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("　 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 间隔时间　")]),s._v("\n          connect_port "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\t\t\t\t "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查的端口\t")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("  \n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br")])]),t("p",[s._v("配置完成后，需要对两台server进行清空路由")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("ipvsadm -C\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("分别启动keepalived服务，此时会加载keepalived配置，实际上跟ipvsadm本质上一致，都是创建了route")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("syetemctl restart keepalived\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"lvs算法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#lvs算法"}},[s._v("#")]),s._v(" LVS算法")]),s._v(" "),t("h3",{attrs:{id:"静态算法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#静态算法"}},[s._v("#")]),s._v(" 静态算法")]),s._v(" "),t("p",[s._v("LVS本身固定的算法分发用户请求")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("算法")]),s._v(" "),t("th",[s._v("简称")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("轮询")]),s._v(" "),t("td",[s._v("Round Robin (rr)")]),s._v(" "),t("td",[s._v("平均的分发请求到后端的各个server")])]),s._v(" "),t("tr",[t("td",[s._v("加权轮询")]),s._v(" "),t("td",[s._v("Weight Round Robin(wrr)")]),s._v(" "),t("td",[s._v("按照权重比例来分发请求到后端server")])]),s._v(" "),t("tr",[t("td",[s._v("源地址散列")]),s._v(" "),t("td",[s._v("Source Hash(sh)")]),s._v(" "),t("td",[s._v("根据用户的ip地址分发，同一个ip最终会落到同一个server")])]),s._v(" "),t("tr",[t("td",[s._v("目标地址散列")]),s._v(" "),t("td",[s._v("Destination Hash (dh)")]),s._v(" "),t("td",[s._v("根据用户的url地址分发，同一个ip最终会落到同一个server")])])])]),s._v(" "),t("h3",{attrs:{id:"动态算法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#动态算法"}},[s._v("#")]),s._v(" 动态算法")]),s._v(" "),t("p",[s._v("根据流量、服务器压力的大小，动态的计算")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("算法")]),s._v(" "),t("th",[s._v("简称")]),s._v(" "),t("th",[s._v("描述")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("最小连接数")]),s._v(" "),t("td",[s._v("Leat Connections "),t("code",[s._v("lc")])]),s._v(" "),t("td",[s._v("分发新的连接数到连接数最小的server")])]),s._v(" "),t("tr",[t("td",[s._v("加权最小连接数")]),s._v(" "),t("td",[s._v("Weight Leat Connections "),t("code",[s._v("wlc")])]),s._v(" "),t("td",[s._v("优先分发到权重较大、连接数最小的server")])]),s._v(" "),t("tr",[t("td",[s._v("最短期望延迟")]),s._v(" "),t("td",[s._v("Shortest Expected Delay "),t("code",[s._v("sed")])]),s._v(" "),t("td",[s._v("特殊的wlc的算法，优先分配给延迟比较低的server")])]),s._v(" "),t("tr",[t("td",[s._v("最小队列调度")]),s._v(" "),t("td",[s._v("Never Queue "),t("code",[s._v("nq")])]),s._v(" "),t("td",[s._v("永不使用队列，优先分发到不需要排队等待运算的server")])])])]),s._v(" "),t("h2",{attrs:{id:"参考链接"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://www.imooc.com/article/79661",target:"_blank",rel:"noopener noreferrer"}},[t("strong",[s._v("大白话理解LVS DR模型中的arp_ignore")]),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"http://www.linuxvirtualserver.org/zh/LVS4.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("LVS的负载调度"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://www.jianshu.com/p/8a61de3f8be9",target:"_blank",rel:"noopener noreferrer"}},[s._v("LVS基本原理"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);a.default=e.exports}}]);